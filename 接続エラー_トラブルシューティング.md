# データベース接続エラーのトラブルシューティング

## エラー内容

```
Error: P1001: Can't reach database server at `db.alnqctmakkhlzwezfibj.supabase.co:5432`
```

## 考えられる原因と対処法

### 1. Supabaseプロジェクトがまだ完全に起動していない

**対処法**:
- Supabaseダッシュボードでプロジェクトのステータスを確認
- プロジェクト作成直後は、データベースの起動に2-3分かかることがあります
- 「Setting up your project...」と表示されている場合は、完了するまで待ってください

### 2. 接続設定の確認（Supabaseダッシュボード）

1. Supabaseダッシュボード → Settings → Database
2. 「Connection pooling」セクションを確認
3. **「Direct connection」を使用しているか確認**（「Session mode」または「Transaction mode」ではない）
4. 接続URLが「Direct connection」のURIであることを確認

### 3. IPアドレスの制限設定

Supabaseのデフォルト設定では、すべてのIPアドレスからの接続が許可されているはずですが、確認してください：

1. Supabaseダッシュボード → Settings → Database
2. 「Connection string」セクション
3. 「Direct connection」のURIを使用

### 4. 接続URLの形式確認

現在の接続URL:
```
postgresql://postgres:dateguide202512@db.alnqctmakkhlzwezfibj.supabase.co:5432/postgres
```

**確認事項**:
- パスワードに特殊文字が含まれていないか（現在は含まれていないので問題なし）
- 接続URL全体が正しくコピーされているか

### 5. パスワードのURLエンコード（必要な場合）

パスワードに特殊文字（`@`, `:`, `/`, `%` など）が含まれる場合は、URLエンコードが必要です。

現在のパスワード `dateguide202512` には特殊文字が含まれていないので、URLエンコードは不要です。

### 6. ネットワーク接続の確認

```bash
# データベースサーバーへの接続テスト
ping db.alnqctmakkhlzwezfibj.supabase.co
```

### 7. 接続URLの再取得

Supabaseダッシュボードから接続URLを再度取得してください：

1. Settings → Database → Connection string
2. 「URI」タブを選択
3. 「Direct connection」のURIをコピー
4. `.env` ファイルの `DATABASE_URL` を更新

---

## 次のステップ

1. **Supabaseダッシュボードでプロジェクトの状態を確認**
   - プロジェクトが完全に起動しているか確認
   - 「Table Editor」が開けるか確認（開ける場合は接続可能）

2. **接続URLを再取得**
   - Settings → Database → Connection string → URI
   - 「Direct connection」のURIを使用

3. **接続URLが正しいか確認**
   - `.env` ファイルの `DATABASE_URL` が正しく設定されているか確認

4. **再度マイグレーションを実行**
   ```bash
   npm run db:migrate
   ```

---

## 確認コマンド

```bash
cd premier-date

# .envファイルの内容を確認
cat .env

# Prisma Clientの再生成（念のため）
npm run db:generate

# マイグレーションを再実行
npm run db:migrate
```

---

**Supabaseプロジェクトが完全に起動しているか確認してから、再度マイグレーションを実行してください！**



