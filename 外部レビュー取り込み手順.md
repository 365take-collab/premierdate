# 外部レビュー取り込み手順

## 概要

食べログ、東京カレンダー、グルナビなどのレビューサイトから、デート関連のレビューのみを抽出して、リライトしてデータベースに追加します。

## 機能

1. **レビュー抽出**: 外部レビューサイトからレビューを取得
2. **デート関連フィルタリング**: デート関連のキーワードを含むレビューのみを抽出
3. **AIリライト**: OpenAI APIを使用してレビューをリライト
4. **データベース追加**: リライトしたレビューをデータベースに追加

## セットアップ

### 1. OpenAI APIキーの設定

`.env`ファイルに以下を追加：

```env
OPENAI_API_KEY=sk-...
```

### 2. 実行

```bash
# テストモード（10件のレストランのみ）
npm run import:external-reviews:test

# 本番モード（全件）
npm run import:external-reviews
```

## デート関連キーワード

以下のキーワードを含むレビューのみが抽出されます：

- デート、恋人、カップル、二人、彼氏、彼女
- 記念日、プロポーズ、結婚記念日
- バレンタイン、ホワイトデー、クリスマス、誕生日
- お祝い、サプライズ、ロマンチック
- 雰囲気、夜景、眺め
- 特別、親密、二人きり
- 静か、落ち着いた、上品、エレガント
- おしゃれ、おしゃれな空間、おしゃれな内装

## レビューサイトのスクレイピング

現在はサンプルデータを使用していますが、実際のレビューサイトからスクレイピングする場合は、各サイトの構造に合わせて実装してください。

### 食べログ

```typescript
// 食べログのレビューセクションを取得
$('.rvw-item').each((_, element) => {
  const ratingText = $(element).find('.rating').text()
  const rating = parseFloat(ratingText) || 0
  const reviewText = $(element).find('.rvw-item__rvw-comment').text().trim()
  // ...
})
```

### 東京カレンダー

```typescript
// 東京カレンダーのレビューセクションを取得
$('.review-item').each((_, element) => {
  // ...
})
```

### グルナビ

```typescript
// グルナビのレビューセクションを取得
$('.review-item').each((_, element) => {
  // ...
})
```

## 注意事項

1. **APIレート制限**: OpenAI APIのレート制限を考慮して、リクエスト間に1秒の待機時間を設けています
2. **重複チェック**: 同じレビューテキストが既に存在する場合はスキップします
3. **匿名レビュー**: 外部レビューは匿名（`is_anonymous: true`）として追加されます
4. **ユーザーID**: 外部レビューはユーザーIDなし（`user_id: null`）で追加されます

## カスタマイズ

### デート関連キーワードの追加

`scripts/import-external-reviews.ts`の`DATE_KEYWORDS`配列にキーワードを追加してください。

### リライトプロンプトの変更

`rewriteReview`関数内のプロンプトを変更することで、リライトのスタイルを調整できます。

### デート適性の計算

現在は評価（rating）をそのままデート適性（date_appropriateness）として使用していますが、レビューテキストからより正確に計算することも可能です。

## トラブルシューティング

### OpenAI APIエラー

- APIキーが正しく設定されているか確認
- APIレート制限に達していないか確認
- エラー時は元のテキストがそのまま使用されます

### スクレイピングエラー

- 各レビューサイトのHTML構造が変更されている可能性があります
- セレクターを確認して修正してください

### データベースエラー

- レストランIDが正しく取得できているか確認
- 重複チェックが正しく動作しているか確認
