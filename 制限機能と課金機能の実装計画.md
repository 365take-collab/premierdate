# 制限機能と課金機能の実装計画

## 📋 実装内容

### 1. 無料プランの制限

- **お気に入り**: 3件まで
- **レビュー投稿**: 月5件まで
- **デートコース提案**: 1件まで

### 2. プレミアムプラン（制限解除）

- **お気に入り**: 無制限
- **レビュー投稿**: 無制限
- **デートコース提案**: 無制限

## ✅ 実装済み

1. **使用制限の定義** (`src/lib/usage-limits.ts`)
   - プランタイプごとの制限を定義
   - 制限チェック関数

2. **ユーザープラン取得** (`src/lib/user-plan.ts`)
   - ユーザーのプランタイプを取得
   - プレミアムユーザーの判定

3. **APIエンドポイントでの制限チェック**
   - `/api/favorites` - お気に入り追加時の制限チェック
   - `/api/restaurants/[id]/reviews` - レビュー投稿時の制限チェック
   - `/api/date-courses` - デートコース作成時の制限チェック

4. **エラーメッセージ**
   - 制限に達した場合、適切なエラーメッセージを返す
   - `upgradeRequired: true` フラグを追加

5. **UIコンポーネント**
   - `UpgradePrompt` コンポーネント（アップグレード促進用）
   - `FavoriteButton` でのエラーハンドリング改善

## ⏳ 残りの実装タスク

### 1. Utage決済との連携

**必要な作業**:
- Utage APIのドキュメント確認
- 決済フローの実装
- 決済確認エンドポイントの実装
- プラン更新処理の完成

**ファイル**: `src/app/api/subscription/upgrade/route.ts`

### 2. サブスクリプションページの作成

**必要なページ**:
- `/subscription` - プラン選択・決済ページ

**必要な機能**:
- プランの表示（月額・年額）
- Utage決済フォームの統合
- 現在のプラン状態の表示
- アップグレード/ダウングレード機能

### 3. フロントエンドでの制限表示

**必要な改善**:
- お気に入りページでの残り件数表示
- レビュー投稿フォームでの残り件数表示
- デートコース提案フォームでの残り件数表示
- 制限に近づいた場合の警告表示

### 4. プラン期限の管理

**必要な機能**:
- サブスクリプション期限の確認
- 期限切れ時の自動ダウングレード
- 期限切れ前の通知

### 5. 使用状況の表示

**必要なページ/機能**:
- マイページまたは設定ページ
- 各機能の使用状況を表示
- 残りクォータの表示

## 🔗 Utage API連携について

UtageのAPIドキュメントに基づいて、以下の機能を実装する必要があります：

1. **決済開始**
   - Utage APIに決済リクエストを送信
   - 決済トークンを取得

2. **決済確認**
   - Utage APIで決済を確認
   - 決済成功時にプランを更新

3. **サブスクリプション管理**
   - キャンセル処理
   - 更新処理
   - ステータス確認

## 📝 注意事項

- 現在の実装では、Utage API連携部分はプレースホルダーです
- 実際のUtage APIドキュメントを確認して、適切に実装する必要があります
- 決済処理はセキュアに実装する必要があります
- エラーハンドリングを適切に行う必要があります



