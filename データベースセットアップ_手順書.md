# デートガイド - データベースセットアップ手順書

この手順書に従って、Supabaseでのデータベースセットアップを進めてください。

---

## Step 1: Supabaseアカウントの作成とプロジェクト作成

### 1-1. Supabaseアカウントの作成

1. [Supabase](https://supabase.com/) にアクセス
2. 「Start your project」をクリック
3. GitHubアカウントでログイン（推奨）またはメールアドレスで登録

### 1-2. プロジェクトの作成

1. ダッシュボードで「New Project」をクリック
2. 以下の情報を入力：
   - **Organization**: 既存のものか、新規作成
   - **Name**: `premier-date`（任意の名前でOK）
   - **Database Password**: **強力なパスワードを設定**（**必ずメモしておく！**）
   - **Region**: `Tokyo (Northeast Asia)` を選択（日本に近いため）
   - **Pricing Plan**: `Free` を選択

3. 「Create new project」をクリック
4. プロジェクトの作成が完了するまで2-3分待つ

---

## Step 2: データベース接続URLの取得

1. プロジェクトのダッシュボードを開く
2. 左メニューから「Settings」→「Database」を選択
3. 「Connection string」セクションで「URI」を選択
4. 表示される接続URLをコピー

**接続URLの例**:
```
postgresql://postgres:[YOUR-PASSWORD]@db.xxxxx.supabase.co:5432/postgres
```

**重要**: `[YOUR-PASSWORD]` の部分を、Step 1-2で設定した実際のパスワードに置き換えてください。

**実際の例**（パスワードが `mySecurePassword123!` の場合）:
```
postgresql://postgres:mySecurePassword123!@db.abcdefghijklmnop.supabase.co:5432/postgres
```

---

## Step 3: 環境変数の設定

### 3-1. .envファイルの作成

プロジェクトルート（`premier-date/`）に `.env` ファイルを作成します。

**重要**: `.env` ファイルは既に `.gitignore` に含まれているので、Gitにコミットされません。

### 3-2. 環境変数の記述

`.env` ファイルに以下を記述してください：

```env
# データベース接続URL（Supabaseから取得したURL）
DATABASE_URL="postgresql://postgres:[YOUR-PASSWORD]@db.xxxxx.supabase.co:5432/postgres"

# NextAuth.js（認証機能用）
# NEXTAUTH_SECRETは、以下のコマンドで生成できます:
# openssl rand -base64 32
NEXTAUTH_SECRET="your-generated-secret-here"
NEXTAUTH_URL="http://localhost:3000"
```

**重要**: 
- `[YOUR-PASSWORD]` を実際のパスワードに置き換えてください
- `NEXTAUTH_SECRET` は、以下のコマンドで生成できます:
  ```bash
  openssl rand -base64 32
  ```

---

## Step 4: データベースマイグレーション

### 4-1. Prismaクライアントの生成

```bash
cd premier-date
npm run db:generate
```

### 4-2. データベースマイグレーション

```bash
npm run db:migrate
```

このコマンドで、Prismaスキーマに基づいてテーブルが作成されます。

マイグレーション実行時に、以下のように聞かれる場合があります：
- `Enter a name for the new migration:` → 任意の名前を入力（例: `init`）してEnter

### 4-3. 初期データの投入（オプション）

```bash
npm run db:seed
```

サンプルデータ（用途カテゴリ、店舗データ）が投入されます。

---

## Step 5: 動作確認

### 5-1. Prisma Studioでデータベースを確認

```bash
npm run db:studio
```

ブラウザでPrisma Studioが開き、データベースの内容を視覚的に確認できます。

### 5-2. 開発サーバーの起動

```bash
npm run dev
```

ブラウザで [http://localhost:3000](http://localhost:3000) を開いて確認してください。

---

## トラブルシューティング

### 接続エラーが発生する場合

1. **接続URLが正しいか確認**
   - パスワードが正しく設定されているか
   - ホスト名が正しいか
   - 特殊文字（`@`, `:`, `/` など）がエスケープされているか

2. **Supabaseの接続設定を確認**
   - Supabaseダッシュボードの「Settings」→「Database」で接続情報を確認
   - 「Connection pooling」ではなく「Direct connection」を使用

3. **Prismaクライアントの再生成**
   ```bash
   npm run db:generate
   ```

### マイグレーションエラーが発生する場合

1. **データベースが空であることを確認**
   - Supabaseダッシュボードの「Table Editor」でテーブルが存在しないことを確認

2. **Prismaスキーマの構文エラーを確認**
   ```bash
   npx prisma format
   ```

3. **既存のマイグレーションを削除して再実行**（注意：データが削除されます）
   ```bash
   # prisma/migrations ディレクトリを削除
   rm -rf prisma/migrations
   
   # マイグレーションを再実行
   npm run db:migrate
   ```

---

## 次のステップ

データベースセットアップが完了したら、以下のステップに進みます：

1. ✅ データベースセットアップ（完了）
2. ⏭️ 認証機能の実装（NextAuth.js）
3. ⏭️ 店舗データの追加

---

**セットアップが完了したら、次のステップに進みましょう！**



