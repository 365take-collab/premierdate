# 住所・緯度経度取得 作業手順

## 概要

東京カレンダーのレストランデータから、詳細ページから住所を取得し、Google Maps Geocoding APIで緯度・経度を取得する手順です。

## 作業の流れ

### 1. 詳細ページから住所を取得

既存のJSONファイルのレストラン情報を更新し、詳細ページから住所を取得します。

```bash
# テスト実行（最初の10件のみ）
npm run update:addresses:test

# 全件実行（約2,600件、時間がかかります）
npm run update:addresses
```

**実行時間の目安**:
- テスト（10件）: 約30秒
- 全件（2,600件）: 約1-2時間（1件あたり約2-3秒）

**注意事項**:
- サーバー負荷を軽減するため、各リクエスト間に1秒の待機時間を設けています
- エラーが発生した場合は、ログを確認して再実行してください

### 2. Google Maps Geocoding APIで緯度・経度を取得

住所が取得できたレストランについて、Google Maps Geocoding APIで緯度・経度を取得します。

#### 事前準備

1. **Google Maps APIキーの取得**
   - [Google Cloud Console](https://console.cloud.google.com/)でプロジェクトを作成
   - Geocoding APIを有効化
   - APIキーを作成

2. **環境変数の設定**

`.env`ファイルに以下を追加：

```env
GOOGLE_MAPS_API_KEY=your-api-key-here
```

#### 実行

```bash
# テスト実行（最初の10件のみ）
npm run geocode:addresses:test

# 全件実行
npm run geocode:addresses
```

**実行時間の目安**:
- テスト（10件）: 約10秒
- 全件（2,600件）: 約45分（1件あたり約1秒、APIレート制限を考慮）

**注意事項**:
- Google Maps Geocoding APIは無料枠で月間$200まで（約40,000リクエスト）
- レート制限を考慮して、1秒に1リクエストに制限しています
- エラーが発生した場合は、APIキーやクォータを確認してください

### 3. データベースへの投入

住所と緯度・経度が取得できたら、データベースに投入します。

```bash
npm run db:import:tokyo-calendar
```

## 進捗確認

### 住所取得の進捗確認

```bash
# ログファイルを確認
tail -f update-addresses.log
```

### 取得状況の確認

```bash
# 住所が取得できた件数を確認
cat scripts/tokyo-calendar-restaurants.json | jq '[.[] | select(.address and (.address | length > 0) and (.address | contains("駅") | not))] | length'

# 緯度・経度が取得できた件数を確認
cat scripts/tokyo-calendar-restaurants.json | jq '[.[] | select(.latitude != null and .longitude != null)] | length'
```

## トラブルシューティング

### 住所が取得できない場合

1. **詳細ページのHTML構造が変更された可能性**
   - テストスクリプトで確認: `npm run test:scrape-details`
   - セレクターを調整する必要があるかもしれません

2. **タイムアウトエラー**
   - ネットワーク接続を確認
   - 待機時間を長くする（`update-addresses-from-details.ts`の`waitForTimeout`を調整）

### 緯度・経度が取得できない場合

1. **APIキーの確認**
   - `.env`ファイルに`GOOGLE_MAPS_API_KEY`が設定されているか確認
   - APIキーが有効か確認

2. **APIクォータの確認**
   - Google Cloud Consoleでクォータを確認
   - 無料枠を超えている場合は、課金設定が必要

3. **住所の形式**
   - 住所が正しい形式か確認（「東京都」で始まるなど）
   - 不正な住所の場合は、手動で修正が必要

## 次のステップ

住所と緯度・経度が取得できたら：

1. **データベースへの投入**: `npm run db:import:tokyo-calendar`
2. **データの確認**: Prisma Studioで確認（`npm run db:studio`）
3. **デート特化情報の追加**: 横並び席、客層、ホテルまでの距離などの情報を手動で追加
